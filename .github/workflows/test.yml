name: Push Docker Image to Cloudsmith

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: write
  id-token: write


jobs:
  push-to-cloudsmith:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install Cloudsmith CLI
        uses: cloudsmith-io/cloudsmith-cli-action@v1.0.3
        with:
          oidc-namespace: "simran-parwani-testorg"
          oidc-service-slug: "access"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.17.3

      # 3️⃣ List repo for debugging (optional)
      - name: List repo structure
        run: ls -R

      # 4️⃣ Build Helm chart
      - name: Build Helm chart
        run: |
          # If your Chart.yaml is at helm/alpacka, cd into it
          if [ -f "helm/alpacka/Chart.yaml" ]; then
            cd helm/alpacka
          fi

          helm dependency update
          helm package . --version 0.0.1 --app-version 0.0.1


      - name: Push to Cloudsmith
        shell: bash
        working-directory: helm/alpacka
        run: |
          echo "${{ secrets.CLOUDSMITH_API_KEY }}" | helm registry login helm.oci.cloudsmith.io --username simran-parwani --password-stdin
          helm push alpacka-0.0.1.tgz oci://helm.oci.cloudsmith.io/simran-parwani-testorg/helm
